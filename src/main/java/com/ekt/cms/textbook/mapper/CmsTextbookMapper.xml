<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ekt.cms.textbook.dao.CmsTextbookMapper">
	<resultMap id="BaseResultMap" type="com.ekt.cms.textbook.entity.CmsTextbook">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="phase_no" property="phaseNo" jdbcType="INTEGER" />
		<result column="grade_no" property="gradeNo" jdbcType="INTEGER" />
		<result column="grade" property="grade" jdbcType="VARCHAR" />
		<result column="subject_no" property="subjectNo" jdbcType="INTEGER" />
		<result column="subject" property="subject" jdbcType="VARCHAR" />
		<result column="publisher_no" property="publisherNo" jdbcType="INTEGER" />
		<result column="publisher" property="publisher" jdbcType="VARCHAR" />
		<result column="textbook_type_no" property="textbookTypeNo" jdbcType="INTEGER" />
		<result column="textbook_type" property="textbookType"
			jdbcType="VARCHAR" />
		<result column="title" property="title" jdbcType="VARCHAR" />
		<result column="knowledge_point_arr" property="knowledgePointArr"
			jdbcType="VARCHAR" />
		<result column="digest" property="digest" jdbcType="VARCHAR" />
		<result column="author" property="author" jdbcType="VARCHAR" />
		<result column="img_url" property="imgUrl" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="real_name" property="inputAccountRealName" jdbcType="VARCHAR" />
		<result column="price" property="price" jdbcType="DOUBLE" />
		<result column="discount" property="discount" jdbcType="DOUBLE" />
		<result column="is_hot" property="isHot" jdbcType="INTEGER" />
		<result column="crate_time" property="crateTime" jdbcType="DATE" />
		<result column="knowledge_point_arr_val" property="knowledgePointArrVal" jdbcType="VARCHAR" />
	</resultMap>
	<select id="listPage" resultMap="BaseResultMap"	parameterType="com.ekt.cms.textbook.entity.CmsTextbook">
				SELECT
					t.id,
					t.title,
					t.phase_no,
					t.grade_no,
					d.`value` grade,
					t.subject_no,
					d1.`value` SUBJECT,
					t.publisher_no,
					d2.`value` publisher,
					t.textbook_type_no,
					d3.`value` textbook_type,
					ft.`name` author,
					t.digest,
					t.knowledge_point_arr,
					t.img_url,
					t.`status`,
					t.input_account_id,
					ac.real_name,
					t.crate_time,
					t.discount,
					t.price,
					t.is_hot
				FROM
				cms_textbook t
				LEFT JOIN cms_account ac on t.input_account_id=ac.id
				LEFT JOIN cms_dictionary d ON t.grade_no = d.id
				LEFT JOIN
				cms_dictionary d1 ON t.subject_no = d1.id
				LEFT JOIN cms_dictionary d2
				ON t.publisher_no = d2.id
				LEFT JOIN cms_dictionary d3 ON
				t.textbook_type_no = d3.id
				LEFT JOIN api_teacher ft on 
				ft.id=t.author_id
				WHERE 1=1
				<if test="textbook.title !=null and textbook.title !=''">
					AND (t.title like '%${textbook.title}%')
				</if>
				<if test="textbook.subjectNo!=null and textbook.subjectNo!='' and textbook.subjectNo !=0">
					AND t.subject_no=#{textbook.subjectNo}
				</if>
				<if test="textbook.gradeNo!=null and textbook.gradeNo!='' and textbook.gradeNo !=0 ">
					AND t.grade_no= #{textbook.gradeNo}
				</if>
				<if test="textbook.publisherNo!=null and textbook.publisherNo!=''">
					AND t.publisher_no= #{textbook.publisherNo}
				</if>
				<if test="textbook.textbookTypeNo !=null and textbook.textbookTypeNo !=''">
					AND t.textbook_type_no=#{textbook.textbookTypeNo}
				</if>
					ORDER BY t.id DESC
			</select>
	<insert id="insertTextbook" parameterType="com.ekt.cms.textbook.entity.CmsTextbook">
			INSERT INTO cms_textbook(
			phase_no,
			grade_no,
			subject_no,
			publisher_no,
			textbook_type_no,
			title,
			knowledge_point_arr,
			knowledge_point_arr_val,
			digest,
			author_id,
			img_url,
			input_account_id,
			crate_time,
			isfree,
			price,
			discount,
			status,
			is_hot
			)VALUES(
				#{phaseNo},
				#{gradeNo },
				#{subjectNo},
				#{publisherNo},
				#{textbookTypeNo},
				#{title},
				#{knowledgePointArr},
				#{knowledgePointArrVal},
				#{digest},		
				#{authorId},
				#{imgUrl},
				#{inputAccountId},
				SYSDATE(),
				#{isFree},
				#{price},
				#{discount},
				1,
				#{isHot}
			)
	</insert>
	<delete id="deleteTextbook" parameterType="java.lang.Integer">
		DELETE FROM cms_textbook WHERE id=#{id}
	</delete>
	
	<update id="confine" parameterType="java.lang.Integer">
		UPDATE cms_textbook SET status = #{status} WHERE id=#{id}
	</update>
	
	<update id="updateTextbook" parameterType="com.ekt.cms.textbook.entity.CmsTextbook">
	
		UPDATE 
			cms_textbook 
		SET 
		<if test="phaseNo !=null and phaseNo !=''">
			phase_no=#{phaseNo},
		</if>
		<if test="gradeNo !=null and gradeNo !=''">
			grade_no=#{gradeNo},
		</if>
		<if test="subjectNo !=null and subjectNo !=''">
			subject_no=#{subjectNo}, 
		</if>
		<if test="publisherNo !=null and publisherNo !=''">
			publisher_no=#{publisherNo}, 
		</if>
		<if test="textbookType !=null and textbookType !=''">
			textbook_type_no=#{textbookType},
		</if>
		<if test="title !=null and title !=''">
			title=#{title}, 
		</if>
			knowledge_point_arr=#{knowledgePointArr},
			knowledge_point_arr_val=#{knowledgePointArrVal},
		<if test="digest !=null and digest !=''">
			digest=#{digest},
		</if>
		<if test="authorId==0">
			author_id=null, 
		</if>
		<if test="authorId!=0">
			author_id=#{authorId}, 
		</if>
		<if test="imgUrl !=null and imgUrl !=''">
			img_url=#{imgUrl}, 
		</if>
		<if test="status !=null and status !=''">
			status=#{status}, 
		</if>
		<if test="inputAccountId !=null and inputAccountId !=0">
			input_account_id =#{inputAccountId}  ,
		</if>
		<if test="price !=null and price !=''">
			price =#{price},
		</if>
		<if test="discount !=null and discount !=''">
			discount =#{discount},
		</if>
			is_hot =#{isHot},
			
			isfree =#{isFree}
			
		WHERE id=#{id};
		
	</update>
	
	
</mapper>